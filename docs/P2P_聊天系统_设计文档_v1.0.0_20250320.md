# P2P聊天系统设计文档 v1.0.0

**日期：** 2025年3月20日
**版本：** 1.0.0
**状态：** 最终版

## 1. 项目概述

P2P聊天系统是一个基于WebRTC技术的点对点通信应用，允许用户无需中央服务器即可进行实时通信。本系统使用PeerJS库简化WebRTC连接建立过程，并提供端到端加密功能以保护用户隐私。系统支持文本消息传输以及文件、图片和视频的安全传输。

## 2. 系统架构

### 2.1 总体架构

系统采用客户端-信令服务器-客户端的架构：
- **客户端**：React.js构建的Web应用
- **信令服务器**：PeerJS服务器（仅用于建立连接）
- **数据传输**：WebRTC点对点连接（不经过服务器）

### 2.2 技术栈

- **前端框架**：React.js 18.2.0
- **WebRTC封装**：PeerJS 1.5.4
- **加密实现**：Web Crypto API (ECDH密钥交换和AES-GCM加密)
- **构建工具**：Webpack 5.98.0, Babel 7.26.10
- **样式**：Styled Components 6.1.16
- **图标库**：React Icons 5.5.0

### 2.3 模块组织

```
src/
├── components/       # UI组件
│   ├── ChatScreen.js        # 聊天界面组件
│   ├── ConnectionScreen.js  # 连接界面组件
│   ├── ErrorScreen.js       # 错误界面组件
│   ├── MessageBubble.js     # 消息气泡组件
│   ├── MessageComposer.js   # 消息输入组件
│   ├── StatusIndicator.js   # 状态指示器组件
│   ├── CopyableId.js        # 可复制ID组件
│   └── Toast.js             # 提示消息组件
├── services/         # 核心服务
│   ├── peerService.js       # WebRTC连接管理
│   ├── encryptionService.js # 加密服务
│   └── messageService.js    # 消息处理
├── styles/           # 全局样式
│   └── global.css           # 全局样式定义
├── App.js            # 应用入口
└── index.js          # 渲染入口
```


## 3. 功能规格

### 3.1 用户界面

- **连接界面**：创建Peer连接和连接到其他用户
- **加密选择**：允许用户选择是否启用加密通信
- **聊天界面**：发送和接收消息（加密或非加密）
- **文件传输界面**：选择、预览和发送文件、图片和视频
- **错误界面**：显示连接或加密错误，提供重试选项

### 3.2 核心功能

- 创建唯一Peer ID（自定义或随机生成）
- 连接到其他用户
- 接受/拒绝连接请求（必须手动确认）
- 端到端加密消息传输（可选择启用或禁用）
- 实时消息发送和接收
- 文件、图片和视频的传输（支持加密和非加密模式）
- 连接状态指示和心跳检测
- 加密状态指示
- 文件传输进度指示
- 连接断开后自动重连尝试

## 4. 连接流程

### 4.1 创建Peer连接

1. 用户输入自定义ID或生成随机ID
2. 创建PeerJS连接
3. 连接成功后显示用户ID，可以复制分享
4. 此时用户已准备好接收连接请求

### 4.2 连接到其他用户

1. 输入目标用户ID
2. 选择是否启用加密通信
3. 发送连接请求
4. 等待对方接受连接
5. 连接建立后，如启用加密则执行密钥交换

### 4.3 接收连接请求

1. 显示连接请求对话框，包含发起方ID和加密设置
2. 用户选择接受或拒绝
3. 接受后建立连接，如启用加密则执行密钥交换
4. 进入聊天界面

## 5. 数据流

### 5.1 消息发送流程

#### 5.1.1 加密模式

1. 用户输入消息
2. 创建消息对象（包含发送者ID、内容和时间戳）
3. 使用Web Crypto API和共享密钥加密消息
4. 通过WebRTC数据通道发送加密消息
5. 对方接收加密消息
6. 使用共享密钥解密消息
7. 显示消息在聊天界面

#### 5.1.2 非加密模式

1. 用户输入消息
2. 创建消息对象（包含发送者ID、内容和时间戳）
3. 直接通过WebRTC数据通道发送消息
4. 对方接收消息
5. 显示消息在聊天界面

### 5.2 文件传输流程

1. 用户选择要发送的文件（文件、图片或视频）
2. 系统读取文件并将其分割为16KB的数据块
3. 发送包含文件名、类型、大小和块数的元数据
4. 逐个发送文件块，每个块在加密模式下使用AES-GCM加密
5. 接收方接收文件元数据和文件块
6. 系统逐块解密（如需要）并重组文件块
7. 根据文件类型提供预览或下载选项

## 6. 安全实现

### 6.1 加密方案

系统使用Web Crypto API实现端到端加密：
- ECDH（椭圆曲线迪菲-赫尔曼）用于密钥交换
- AES-GCM用于消息和文件加密

### 6.2 密钥交换流程

1. 连接建立后，双方生成ECDH密钥对（公钥和私钥）
2. 双方交换公钥
3. 双方使用自己的私钥和对方的公钥派生共享密钥
4. 双方发送"加密就绪"确认消息
5. 确认收到后开始加密通信

### 6.3 安全考虑

- 密钥仅存储在内存中，不保存到本地存储
- 每次会话生成新的密钥对
- 文件块单独加密，确保大文件传输安全
- 使用安全的随机IV（初始化向量）增强加密安全性
- 会话结束后自动清除所有密钥

## 7. 用户体验设计

### 7.1 连接状态指示

- 未连接：显示连接指南
- 连接中：显示进度指示
- 已连接：显示绿色状态图标
- 连接断开：显示重连选项

### 7.2 加密状态指示

- 加密已启用：显示加密状态和锁图标
- 加密通道建立中：显示进度指示
- 加密就绪：显示确认信息
- 加密已禁用：显示警告信息

### 7.3 文件传输体验

- 文件选择：提供文件、图片和视频的专用按钮
- 文件预览：选择后显示预览（图片和视频）
- 传输进度：显示进度条和百分比
- 文件接收：根据类型自动提供预览或下载选项

## 8. 核心组件详解

### 8.1 peerService.js

负责WebRTC连接管理：
- 创建和管理Peer连接
- 处理数据传输
- 实现文件分块传输
- 提供心跳检测
- 处理连接断开和重连

### 8.2 encryptionService.js

负责加密功能：
- 实现ECDH密钥交换
- 提供AES-GCM加密和解密
- 处理加密状态管理
- 支持二进制数据加密（用于文件传输）

### 8.3 ChatScreen.js

负责聊天界面：
- 显示消息历史
- 处理消息发送和接收
- 管理文件传输
- 显示连接和加密状态
- 处理重连请求

### 8.4 ConnectionScreen.js

负责连接管理：
- 创建Peer连接
- 发起连接请求
- 处理连接请求接受/拒绝
- 执行初始密钥交换

## 9. 性能优化

### 9.1 文件传输优化

- 文件分块传输（16KB/块）避免WebRTC数据通道限制
- 二进制数据传输提高效率
- 支持大文件传输的块缓冲管理
- 文件类型自动识别提供适当预览

### 9.2 连接稳定性

- 心跳检测确保连接状态实时监控
- 自动重连机制在连接断开时尝试恢复
- 连接状态监控提供用户反馈
- 优化事件监听器管理防止内存泄漏

### 9.3 UI响应优化

- 异步处理密钥生成和加密操作
- 优化组件渲染减少不必要更新
- 文件传输进度实时显示
- 使用React引用跟踪清理资源

## 10. 已知限制

- 目前仅支持两人之间的通信
- 不支持离线消息
- 在某些网络环境下可能需要TURN服务器辅助连接
- 大文件传输可能受到浏览器内存限制
- 需要在HTTPS环境下运行才能使用Web Crypto API

## 11. 未来改进方向

- 实现群组聊天功能
- 添加消息持久化机制
- 支持语音和视频通话
- 优化移动设备体验
- 添加端到端的文件加密完整性验证
- 实现自定义STUN/TURN服务器配置
- 添加离线消息队列支持

## 12. 结论

P2P聊天系统提供了一个安全、高效的点对点通信解决方案，通过WebRTC技术和端到端加密实现了直接的安全通信。系统支持文本消息和各类文件的传输，并提供良好的用户体验和连接稳定性保障。通过分块传输和二进制数据处理，成功解决了WebRTC通道大小限制问题，使用户可以安全传输大型文件。系统架构清晰，代码组织良好，为未来功能扩展提供了坚实基础。 